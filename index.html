<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Carta Natal ‚Äî Estable (sin WASM)</title>
<style>
:root{--bg:#fff7fb;--panel:#ffffff;--text:#2a2a31;--muted:#6b7280;--accent:#f4a7d7;--accent-2:#ffd1e8;--stroke:#f0e6f2}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:linear-gradient(180deg,#fff7fb 0%,#fff 50%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px}
h1{font-size:clamp(22px,3vw,32px);margin:0 0 6px}
.subtitle{color:var(--muted);margin-bottom:20px}
.grid{display:grid;grid-template-columns:1.05fr 1fr;gap:20px}
form{background:var(--panel);padding:16px;border-radius:20px;box-shadow:0 8px 30px rgba(244,167,215,.25);border:1px solid var(--stroke)}
.field{display:flex;flex-direction:column;gap:6px;min-width:0}
label{font-size:14px}
input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:#fff;color:var(--text);min-height:44px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:10px}
.time-wrap{display:flex;gap:10px;align-items:center}
.check-wrap{display:flex;align-items:center;gap:6px;white-space:nowrap}
button{cursor:pointer;background:var(--accent);border:none;font-weight:700;margin-top:12px;transition:transform .05s ease, box-shadow .2s ease;box-shadow:0 6px 20px rgba(244,167,215,.45)}
button:hover{transform:translateY{-1px}}
button:active{transform:translateY(0)}
button:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}
.hint{font-size:12px;color:var(--muted)}
.panel{background:var(--panel);padding:16px;border-radius:20px;box-shadow:0 8px 30px rgba(244,167,215,.25);border:1px solid var(--stroke)}
#paper{width:100%;min-height:820px}
.results{margin-top:12px;font-size:14px;line-height:1.5}
.tag{display:inline-block;background:#fff;border:1px solid var(--stroke);padding:2px 6px;border-radius:8px;margin:2px 4px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--accent-2);border:1px solid var(--stroke);font-size:12px}
.autocomplete{position:relative}
.ac-list{position:absolute;z-index:50;top:100%;left:0;right:0;background:#fff;border:1px solid var(--stroke);border-radius:12px;margin-top:6px;box-shadow:0 8px 30px rgba(0,0,0,.08);max-height:220px;overflow:auto}
.ac-item{padding:10px 12px;cursor:pointer}
.ac-item:hover{background:#fff7fb}
.err{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:10px;border-radius:10px;margin-top:10px;white-space:pre-wrap}
.controls{display:flex;gap:8px;flex-wrap:wrap}
@media (max-width: 920px){
  .grid{grid-template-columns:1fr}
  .row{grid-template-columns:1fr}
  .time-wrap{flex-wrap:wrap}
}
</style>

<!-- Dibujo del gr√°fico -->
<script src="https://unpkg.com/@astrodraw/astrochart" crossorigin="anonymous"></script>
<!-- Exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/3.0.10/umd.min.js"></script>
<!-- Zonas horarias -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<!-- Motor astron√≥mico JS (sin WASM) -->
<script src="https://unpkg.com/astronomy-engine@2.1.0/astronomy.browser.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Calculadora de Carta Natal</h1>
  <div class="subtitle">Tropical ¬∑ Sin WASM (estable). Casas Whole Sign opcionales ‚Äî te las integro luego si quieres.</div>

  <div class="grid">
    <form id="form">
      <div class="row">
        <div class="field">
          <label>Nombre</label>
          <input id="name" placeholder="Ej: Ana" />
        </div>
        <div class="field">
          <label>Sexo (opcional)</label>
          <select id="gender">
            <option value="">Prefiero no decir</option>
            <option value="F">Femenino</option>
            <option value="M">Masculino</option>
            <option value="X">No binario</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Fecha de nacimiento</label>
          <input id="date" type="date" required />
        </div>
        <div class="field">
          <label>Hora exacta (24h)</label>
          <div class="time-wrap">
            <input id="time" type="time" step="60" required />
            <label class="check-wrap"><input type="checkbox" id="unknownTime"> No conozco la hora</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Zona horaria</label>
          <select id="tzSelect"></select>
          <div class="hint">Se ajusta autom√°ticamente por horario de verano seg√∫n la fecha.</div>
        </div>
        <div class="field">
          <label>Ciudad y pa√≠s</label>
          <div class="autocomplete">
            <input id="place" placeholder="Ej: La Habana, Cuba" autocomplete="off" required />
            <div id="ac" class="ac-list" style="display:none"></div>
          </div>
          <div class="hint">Empieza a escribir y selecciona del men√∫.</div>
        </div>
      </div>

      <div class="controls">
        <button id="btn" type="submit">Calcular carta</button>
        <button id="btnDemo" type="button">Probar DEMO</button>
        <button id="btnPdf" type="button">Descargar PDF</button>
      </div>

      <div id="errors" class="err" style="display:none"></div>
    </form>

    <div class="panel">
      <div class="badge">ü™ê Gr√°fico</div>
      <div id="paper"></div>
      <div class="results" id="results"></div>
    </div>
  </div>
</div>

<script type="module">
/* ===== DOM ===== */
const form = document.getElementById('form');
const btn = document.getElementById('btn');
const btnDemo = document.getElementById('btnDemo');
const btnPdf = document.getElementById('btnPdf');
const results = document.getElementById('results');
const tzSelect = document.getElementById('tzSelect');
const unknownTime = document.getElementById('unknownTime');
const errorsBox = document.getElementById('errors');
const acBox = document.getElementById('ac');
const placeInput = document.getElementById('place');

/* ===== CONFIG ===== */
const MAPBOX_TOKEN = 'pk.eyJ1Ijoic2hpbmluZ3N0YXJzIiwiYSI6ImNtZTJ4eGF1MjAxZGEya29nNWdhZ3huOHAifQ.lFMgUKBVZnMC8w0--4A52Q'; // tu token
let lastPlace = null;

/* ===== UI helpers ===== */
function showError(err){
  const text = (err && err.stack) ? err.stack : (err?.message || String(err));
  errorsBox.style.display = 'block';
  errorsBox.textContent = text;
}
function clearError(){ errorsBox.style.display='none'; errorsBox.textContent=''; }

unknownTime.addEventListener('change', ()=>{
  const t = document.getElementById('time');
  t.disabled = unknownTime.checked;
  t.required = !unknownTime.checked;
});

/* Timezones */
const IANA_ZONES = (Intl.supportedValuesOf ? Intl.supportedValuesOf('timeZone') : [luxon.DateTime.local().zoneName]) || [];
(function buildTimezoneSelect(){
  const guess = luxon.DateTime.local().zoneName;
  const preferred = [guess,'America/Panama','America/Mexico_City','America/Bogota','America/New_York','America/Los_Angeles','Europe/Madrid','Europe/London','UTC'];
  const set = new Set([...preferred, ...IANA_ZONES]);
  tzSelect.innerHTML = '';
  for(const z of set){
    const opt = document.createElement('option');
    opt.value = z; opt.textContent = z; if(z===guess) opt.selected = true;
    tzSelect.appendChild(opt);
  }
})();

function offsetHoursFor(dateISO, zone){
  const dt = luxon.DateTime.fromISO(dateISO, { zone });
  const off = dt.offset/60;
  return Number.isFinite(off) ? off : 0;
}

/* ===== Geocoding + Autocomplete ===== */
async function mapboxSuggest(q){
  const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${MAPBOX_TOKEN}&language=es&limit=5`;
  const res = await fetch(url);
  const data = await res.json();
  return data.features || [];
}
async function geocodeSmart(q){
  try{
    const features = await mapboxSuggest(q);
    if(!features.length) throw new Error('No se encontr√≥ la ubicaci√≥n.');
    const f = features[0];
    return { lat: f.center[1], lon: f.center[0], label: f.place_name };
  }catch(e){
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers: { 'Accept-Language':'es' } });
    const data = await res.json();
    if(!data.length) throw new Error('No se pudo geocodificar.');
    const b = data[0];
    return { lat: parseFloat(b.lat), lon: parseFloat(b.lon), label: b.display_name };
  }
}
placeInput.addEventListener('input', async ()=>{
  const q = placeInput.value.trim();
  lastPlace = null;
  if(q.length < 3){ acBox.style.display='none'; acBox.innerHTML=''; return; }
  try{
    const feats = await mapboxSuggest(q);
    acBox.innerHTML = '';
    for(const f of feats){
      const div = document.createElement('div');
      div.className = 'ac-item';
      div.textContent = f.place_name;
      div.onclick = ()=>{
        placeInput.value = f.place_name;
        lastPlace = { lat: f.center[1], lon: f.center[0], label: f.place_name };
        acBox.style.display='none';
      };
      acBox.appendChild(div);
    }
    acBox.style.display = (acBox.children.length ? 'block' : 'none');
  }catch(e){ acBox.style.display='none'; }
});
document.addEventListener('click', (e)=>{ if(!acBox.contains(e.target) && e.target!==placeInput){ acBox.style.display='none'; }});

/* ===== Astronomy (sin WASM) ===== */
const bodies = ['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto'];

function toUtcDate(date, time, zone){
  const dt = luxon.DateTime.fromISO(`${date}T${time||'00:00'}`, { zone });
  return new Date(dt.toUTC().toISO());
}

// Sol: geoc√©ntrico = SolarLongitude + 180¬∞
function eclipticLongitudes(dateUTC){
  const out = {};
  for (const b of bodies) {
    let lon;
    if (b === 'Sun') {
      // Sol geoc√©ntrico = longitud helioc√©ntrica de la Tierra + 180¬∞
      lon = (Astronomy.EclipticLongitude('Earth', dateUTC) + 180) % 360;
    } else {
      lon = Astronomy.EclipticLongitude(b, dateUTC);
    }
    out[b] = (lon % 360 + 360) % 360;
  }
  return out;
}

/* ===== Dibujo rueda (sin casas) ===== */
function drawWheel(planetsLongitudes){
  const data = { planets:{}, cusps: [] };
  for(const b of bodies){ data.planets[b] = [ planetsLongitudes[b] ]; }
  const container = document.getElementById('paper');
  container.innerHTML = '';
  new Chart('paper', 800, 800).radix(data);
}

/* ===== PDF ===== */
async function downloadPDF(){
  const svgEl = document.querySelector('#paper svg');
  if(!svgEl) return alert('Genera la carta primero.');
  const serializer = new XMLSerializer();
  const svgStr = serializer.serializeToString(svgEl);
  const canvas = document.createElement('canvas');
  canvas.width = 1700; canvas.height = 1700;
  const ctx = canvas.getContext('2d');
  await window.canvg.Canvg.fromString(ctx, svgStr).render();
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:[900,1100] });
  const margin=40, imgW=820, imgH=820;
  pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
  pdf.text('Carta Natal ‚Äî Tropical (sin casas)', margin, 36+margin);
  pdf.addImage(imgData,'PNG',margin,60+margin,imgW,imgH);
  pdf.save('carta-natal.pdf');
}
btnPdf.addEventListener('click', downloadPDF);

/* ===== Calcular ===== */
async function calculate({name, date, time, zone, place, demo=false}){
  clearError(); btn.disabled = true;
  try{
    let loc;
    if(demo){
      loc = { lat: 8.9824, lon: -79.5199, label:'Ciudad de Panam√°, Panam√°' };
      date = '1992-03-06'; time = '10:45'; zone = 'America/Panama';
      placeInput.value = loc.label;
    }else{
      if(lastPlace){ loc = lastPlace; }
      else { loc = await geocodeSmart((place||'').trim()); }
    }
    if(!date) throw new Error('Falta la fecha.');

    const whenUTC = toUtcDate(date, time, zone || 'UTC');
    const lons = eclipticLongitudes(whenUTC);
    drawWheel(lons);

    const signNames = ['Aries','Tauro','G√©minis','C√°ncer','Leo','Virgo','Libra','Escorpio','Sagitario','Capricornio','Acuario','Piscis'];
    const list = bodies.map(b=>{
      const lon = lons[b]; const sign = Math.floor(lon/30); const deg = lon%30;
      return `<span class="tag">${b}: ${signNames[sign]} ${deg.toFixed(1)}¬∞</span>`;
    }).join('');
    results.innerHTML = `<div><b>${name||'Sin nombre'}</b> ‚Äî ${loc.label}</div><div style="margin-top:8px">${list}</div>`;
  }catch(err){ showError(err); console.error(err); }
  finally{ btn.disabled = false; }
}

/* Submit */
form.addEventListener('submit', (e)=>{
  e.preventDefault();
  calculate({
    name: document.getElementById('name').value.trim(),
    date: document.getElementById('date').value,
    time: document.getElementById('time').value,
    zone: tzSelect.value,
    place: document.getElementById('place').value
  });
});

/* Demo */
btnDemo.addEventListener('click', ()=>{
  document.getElementById('date').value = '1992-03-06';
  document.getElementById('time').value = '10:45';
  document.getElementById('place').value = 'Ciudad de Panam√°, Panam√°';
  calculate({
    name:'Demo', date:'1992-03-06', time:'10:45',
    zone: tzSelect.value || 'America/Panama',
    place:'Ciudad de Panam√°, Panam√°', demo:true
  });
});
</script>
</body>
</html>
