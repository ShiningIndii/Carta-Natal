<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Carta Natal</title>
<style>
:root{--bg:#fff7fb;--panel:#ffffff;--text:#2a2a31;--muted:#6b7280;--accent:#f4a7d7;--accent-2:#ffd1e8;--stroke:#f0e6f2}
html,body{margin:0;padding:0;background:linear-gradient(180deg,#fff7fb 0%,#fff 50%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px}
h1{font-size:clamp(22px,3vw,32px);margin:0 0 6px}
.subtitle{color:var(--muted);margin-bottom:20px}
.grid{display:grid;grid-template-columns:1.1fr 1fr;gap:20px}
form{background:var(--panel);padding:16px;border-radius:20px;box-shadow:0 8px 30px rgba(244,167,215,.25);border:1px solid var(--stroke)}
label{display:block;font-size:14px;margin:10px 0 6px}
input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:#fff;color:var(--text)}
.row{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:16px;margin-top:6px}
button{cursor:pointer;background:var(--accent);border:none;font-weight:700;margin-top:12px;transition:transform .05s ease, box-shadow .2s ease;box-shadow:0 6px 20px rgba(244,167,215,.45)}
button:hover{transform:translateY(-1px)}
button:active{transform:translateY(0)}
button:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}
.hint{font-size:12px;color:var(--muted)}
.notice{font-size:12px;color:#6b7280;margin-top:10px}
.panel{background:var(--panel);padding:16px;border-radius:20px;box-shadow:0 8px 30px rgba(244,167,215,.25);border:1px solid var(--stroke)}
#paper{width:100%;min-height:820px}
.results{margin-top:12px;font-size:14px;line-height:1.5}
.tag{display:inline-block;background:#fff;border:1px solid var(--stroke);padding:2px 6px;border-radius:8px;margin:2px 4px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--accent-2);border:1px solid var(--stroke);font-size:12px}
.err{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:10px;border-radius:10px;margin-top:10px;white-space:pre-wrap}
.controls{display:flex;gap:8px;flex-wrap:wrap}
@media (max-width: 980px){.grid{grid-template-columns:1fr}}
</style>

<!-- Dibujo del gr√°fico -->
<script src="https://unpkg.com/@astrodraw/astrochart" crossorigin="anonymous"></script>
<!-- Exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/3.0.10/umd.min.js"></script>
<!-- Zonas horarias -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Calculadora de Carta Natal</h1>
  <div class="subtitle">Tropical ¬∑ Casas Whole Sign ¬∑ Modo seguro con prueba DEMO.</div>

  <div class="grid">
    <form id="form">
      <div class="row">
        <div>
          <label>Nombre</label>
          <input id="name" placeholder="Ej: Ana" />
        </div>
        <div>
          <label>Sexo (opcional)</label>
          <select id="gender">
            <option value="">Prefiero no decir</option>
            <option value="F">Femenino</option>
            <option value="M">Masculino</option>
            <option value="X">No binario</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fecha de nacimiento</label>
          <input id="date" type="date" required />
        </div>
        <div>
          <label>Hora exacta (24h) <input type="checkbox" id="unknownTime"> No conozco la hora</label>
          <input id="time" type="time" step="60" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Zona horaria</label>
          <select id="tzSelect"></select>
          <div class="hint">Se ajusta autom√°ticamente por horario de verano seg√∫n la fecha.</div>
        </div>
        <div>
          <label>Ciudad y pa√≠s</label>
          <input id="place" placeholder="Ej: La Habana, Cuba" autocomplete="off" required />
          <div class="hint">Puedes escribir: ‚ÄúLa Habana, Cuba‚Äù o ‚ÄúCiudad de Panam√°, Panam√°‚Äù.</div>
        </div>
      </div>

      <div class="controls">
        <button id="btn" type="submit">Calcular carta</button>
        <button id="btnDemo" type="button">Probar DEMO</button>
        <button id="btnPdf" type="button">Descargar PDF</button>
      </div>

      <div class="notice">Swiss Ephemeris: GPL para proyectos open-source. Para uso comercial/cerrado, requiere licencia de Astrodienst.</div>
      <div id="errors" class="err" style="display:none"></div>
    </form>

    <div class="panel">
      <div class="badge">ü™ê Gr√°fico</div>
      <div id="paper"></div>
      <div class="results" id="results"></div>
      <div class="footer">
        <div>ü™ê C√°lculo: Swiss Ephemeris (WASM) ¬∑ Dibujo: AstroChart ¬∑ Casas: Whole Sign ¬∑ Zodiaco: Tropical</div>
        <div id="meta"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== L√ìGICA (versi√≥n fija 0.0.2) ===== -->
<script type="module">
/* Swiss Ephemeris ‚Äî TODO 0.0.2 (JS + ejemplos) */
import SwissEph from 'https://cdn.jsdelivr.net/gh/prolaxu/swisseph-wasm@0.0.2/src/swisseph.js';
import { BirthChartCalculator } from 'https://cdn.jsdelivr.net/gh/prolaxu/swisseph-wasm@0.0.2/examples/birth-chart.js';

/* DOM */
const form = document.getElementById('form');
const btn = document.getElementById('btn');
const btnDemo = document.getElementById('btnDemo');
const btnPdf = document.getElementById('btnPdf');
const results = document.getElementById('results');
const meta = document.getElementById('meta');
const tzSelect = document.getElementById('tzSelect');
const unknownTime = document.getElementById('unknownTime');
const errorsBox = document.getElementById('errors');

/* CONFIG */
const MAPBOX_TOKEN = 'pk.eyJ1Ijoic2hpbmluZ3N0YXJzIiwiYSI6ImNtZTJ4eGF1MjAxZGEya29nNWdhZ3huOHAifQ.lFMgUKBVZnMC8w0--4A52Q';

/* Helpers */
function showError(err){
  const text = (err && err.stack) ? err.stack : (err?.message || String(err));
  errorsBox.style.display = 'block';
  errorsBox.textContent = text;
}
function clearError(){ errorsBox.style.display='none'; errorsBox.textContent=''; }

const IANA_ZONES = (Intl.supportedValuesOf ? Intl.supportedValuesOf('timeZone') : [luxon.DateTime.local().zoneName]) || [];
function buildTimezoneSelect(){
  const guess = luxon.DateTime.local().zoneName;
  const preferred = [guess,'America/Panama','America/Mexico_City','America/Bogota','America/New_York','America/Los_Angeles','Europe/Madrid','Europe/London','UTC'];
  const set = new Set([...preferred, ...IANA_ZONES]);
  tzSelect.innerHTML = '';
  for(const z of set){
    const opt = document.createElement('option');
    opt.value = z; opt.textContent = z; if(z===guess) opt.selected = true;
    tzSelect.appendChild(opt);
  }
}
buildTimezoneSelect();

function offsetHoursFor(dateISO, zone){
  const dt = luxon.DateTime.fromISO(dateISO, { zone });
  return dt.offset / 60;
}

/* Geocoding Mapbox -> OSM fallback */
async function geocodeMapbox(q){
  const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${MAPBOX_TOKEN}&language=es&limit=1`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Mapbox fall√≥: ' + res.status + ' ' + res.statusText);
  const data = await res.json();
  if(!data.features?.length) throw new Error('Mapbox no encontr√≥ la ubicaci√≥n');
  const f = data.features[0];
  return { lat: f.center[1], lon: f.center[0], label: f.place_name, source:'mapbox' };
}
async function geocodeOSM(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
  const res = await fetch(url, { headers: { 'Accept-Language':'es' } });
  if(!res.ok) throw new Error('OSM fall√≥: ' + res.status + ' ' + res.statusText);
  const data = await res.json();
  if(!data.length) throw new Error('OSM no encontr√≥ la ubicaci√≥n');
  const b = data[0];
  return { lat: parseFloat(b.lat), lon: parseFloat(b.lon), label: b.display_name, source:'osm' };
}
async function geocodeSmart(q){
  try{
    if(!MAPBOX_TOKEN || MAPBOX_TOKEN.includes('REEMPLAZA')) throw new Error('Sin token Mapbox');
    return await geocodeMapbox(q);
  }catch(e){
    console.warn('Mapbox fall√≥, usando OSM:', e);
    return await geocodeOSM(q);
  }
}

/* Dibujo */
function drawChart({ planetsLongitudes, houseCusps }){
  const data = { planets:{}, cusps: houseCusps };
  const names = ['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto'];
  names.forEach(n => { data.planets[n] = [planetsLongitudes[n]]; });
  const container = document.getElementById('paper');
  container.innerHTML = '';
  new Chart('paper', 800, 800).radix(data);
}

/* PDF */
async function downloadPDF(){
  const svgEl = document.querySelector('#paper svg');
  if(!svgEl) return alert('Genera la carta primero.');
  const serializer = new XMLSerializer();
  const svgStr = serializer.serializeToString(svgEl);
  const canvas = document.createElement('canvas');
  canvas.width = 1700; canvas.height = 1700;
  const ctx = canvas.getContext('2d');
  await window.canvg.Canvg.fromString(ctx, svgStr).render();
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:[900,1100] });
  const margin=40, imgW=820, imgH=820;
  pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
  pdf.text('Carta Natal ‚Äî Whole Sign (Tropical)', margin, 36+margin);
  pdf.addImage(imgData,'PNG',margin,60+margin,imgW,imgH);
  const metaTxt = document.getElementById('results').innerText || '';
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
  const lines = pdf.splitTextToSize(metaTxt, 900 - margin*2);
  pdf.text(lines, margin, 60+margin+imgH+24);
  pdf.save('carta-natal.pdf');
}
btnPdf.addEventListener('click', downloadPDF);

/* Hora desconocida toggle */
unknownTime.addEventListener('change', ()=>{
  const t = document.getElementById('time');
  t.disabled = unknownTime.checked;
  t.required = !unknownTime.checked;
});

/* C√°lculo principal */
async function calculate({name, date, time, zone, place, demo=false}){
  clearError(); btn.disabled=true;
  try{
    let loc;
    if(demo){
      loc = { lat: 8.9824, lon: -79.5199, label:'Ciudad de Panam√°, Panam√°', source:'demo' };
    }else{
      if(!place || place.trim().length<3) throw new Error('Escribe ciudad y pa√≠s.');
      loc = await geocodeSmart(place.trim());
    }

    if(!date) throw new Error('Falta la fecha.');
    const [Y,M,D] = date.split('-').map(Number);
    let h=0, m=0;
    if(!unknownTime.checked && time){ [h,m] = time.split(':').map(Number); }
    const tz = offsetHoursFor(`${date}T${time || '00:00'}`, zone || 'UTC');

    /* >>>>>>> CLAVE: WASM 0.0.2 <<<<<<<< */
    const calculator = new BirthChartCalculator(new SwissEph({
      locateFile: (f) => `https://cdn.jsdelivr.net/gh/prolaxu/swisseph-wasm@0.0.2/wasm/${f}`
    }));
    await calculator.init();

    const chart = await calculator.calculateBirthChart({
      year:Y, month:M, day:D, hour:h, minute:m,
      timezone: tz, latitude: loc.lat, longitude: loc.lon,
      zodiac:'tropical', houseSystem:'W'
    });

    const planetsLongitudes = {};
    for(const [key,p] of Object.entries(chart.planets)){
      planetsLongitudes[p.name || key] = p.ecliptic.lon;
    }
    drawChart({ planetsLongitudes, houseCusps: chart.houses.cusps });

    const signFmt=(z)=>`${z.sign} ${z.deg.toFixed(0)}¬∞${z.min.toFixed(0)}'`;
    const list = Object.values(chart.planets).map(p=>`<span class="tag">${p.symbol} ${p.name}: ${signFmt(p.zodiacSign)}</span>`).join('');
    results.innerHTML = `<div><b>${name || 'Sin nombre'}</b> ‚Äî ${loc.label} <span class="hint">(via ${loc.source})</span></div><div style="margin-top:8px">${list}</div>`;
    meta.textContent = `Ascendente ${signFmt(chart.points.Ascendant.zodiacSign)} ¬∑ MC ${signFmt(chart.points.Midheaven.zodiacSign)} ¬∑ Casas: ${chart.houses.system}`;

    calculator.destroy();
  }catch(err){ showError(err); console.error(err); }
  finally{ btn.disabled=false; }
}

/* Submit */
form.addEventListener('submit', (e)=>{
  e.preventDefault();
  calculate({
    name: document.getElementById('name').value.trim(),
    date: document.getElementById('date').value,
    time: document.getElementById('time').value,
    zone: tzSelect.value,
    place: document.getElementById('place').value
  });
});

/* Demo */
btnDemo.addEventListener('click', ()=>{
  document.getElementById('date').value = '1992-03-06';
  document.getElementById('time').value = '10:45';
  document.getElementById('place').value = 'Ciudad de Panam√°, Panam√°';
  calculate({
    name:'Demo', date:'1992-03-06', time:'10:45',
    zone: tzSelect.value || 'America/Panama',
    place:'Ciudad de Panam√°, Panam√°', demo:true
  });
});
</script>
</body>
</html>
